Файловая система
===

# События файловой системы

Большинство операционных систем предоставляют возможность подписаться на события от файловой системы.
В Linux системах эта возможность предоставляется через библиотеку [inotify](https://en.wikipedia.org/wiki/Inotify),
в BSD системах (включая MacOS) эта возможность предоставляется самим ядром ОС через [kqueue](https://en.wikipedia.org/wiki/Kqueue).

Что бы подписаться на событие от файловой системы необходимо указать для какого файла и какие события вы хотите поймать.
При события последовательность получит массив где ключ - название файла, значение - тип события у файла. 

```php

ION\FS::watch('/etc/app/main.conf', ION\FS::WATCH_MODIFY)->then(function (array $files) {
   // цикл указан для демонстрации результата наблюдений за файловой системе
   // в нашем примере в нем нет необходимости так как мы слушаем только один файл и одно его событие
   foreach($files as $file => $event) {
       // $file == '/etc/app/main.conf'
       // $event == ION\FS::WATCH_MODIFY
   }
});
```

# Чтение файлов

Чтение файловой системы предоставляется силами библиотеки `libevent`, а конкретнее механизмом [sendfile](http://man7.org/linux/man-pages/man2/sendfile.2.html).
Механизм `sendfile` предназначен для копирования данных файла в сокет, но он так же отлично подходит для обычного асинхронного чтения.
Если механизм `sendfile` не поддерживается, то будет использован механизм [mmap](#).
Если не поддерживается `mmap` то будет обычное синхронное чтение файла.
Чтобы узнать какой механизм будет использован посмотрите параметр `ion.engine.sendfile`, вызвав в консоле `php --ri ion`.


Пример чтения файла через [корутину](./promisor.md#Корутины)

```php
// чтение всего файла
$data = yield ION\FS::readFile('/etc/app/main.conf');

// чтение части файла
$data = yield ION\FS::readFile('/var/log/app/error.log', 0, 8 * KiB); // прочитает первые 8192 байт
```